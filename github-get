#!/bin/sh

# github-get/github-get

set -eu

usage() {
    cat <<EOF
Usage: $(basename ${0}) GITHUB_URL [RELEASE]
Download, unpack, and symlink given github project release (default latest).

Example:
  $(basename ${0}) https://github.com/tianocore/edk2 vUDK2017
EOF
}

die() { { echo "ERROR: ${@}"; usage; } >&2; exit 1; }

version_latest() {
    (
        cd $(mktemp -d)
        curl -sL "${1}/releases" >releases
        grep -Eo '[^/]+\.tar\.gz' releases >tarballs
        sed 's/\.tar\.gz//' tarballs >versions
        sort -Vo versions versions
        tail -1 versions
        rm -rf ${PWD}
    )
}

[ 0 -lt ${#} ] || die "bad args"
github_url="${1}"
version="${2:-$(version_latest ${github_url})}"
project="$(basename ${github_url})"
project_version="${project}-${version}"
curl -Lo ${project_version}.tar.gz ${github_url}/archive/${version}.tar.gz
# github convention: project, hyphen, tagname; force it
mkdir -vp ${project_version}
tar -C ${project_version} --strip-components 1 -xf ${project_version}.tar.gz
ln -vsnf ${project_version} ${project}
