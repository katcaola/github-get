#!/bin/sh

# github-get

set -eu

usage() {
    cat <<EOF
$(basename ${0}) GITHUB_URL [VERSION]

Download, unpack, and softlink a github project (latest release by default) in
the current working directory.

EOF
}

die() { { echo "ERROR: ${@}" ; usage ; } >&2 ; exit 1 ; }

version_latest() {
    (
        cd $(mktemp -d)
        curl -sL "${1}/releases" >releases
        grep -Eo '[^/]+\.tar\.gz' releases >tarballs
        sed 's/\.tar\.gz//' tarballs >versions
        sort -Vo versions versions
        tail -1 versions
    )
}

[ 0 -lt ${#} ] || die "bad args"
github_url="${1}"
version="${2:-$(version_latest ${github_url})}"
project="$(basename ${github_url})"
# github convention: project, hyphen, tagname
project_version="${project}-${version}"
curl -Lo ${project_version}.tar.gz ${github_url}/archive/${version}.tar.gz
tar -vxf ${project_version}.tar.gz
ln -vs ${project_version} ${project}
